octavia_controlplane
=========

This role install the Octavia control plane (controller worker, health manager, housekeeping) on a node. This needs to be a node where an integration bridge managed by Neutron is deployed, as we will attach to the integration bridge to connect to the load balancer network

## Certificate setup

Certificates for Octavia are a bit tricky. The controller and the agent on each amphora communicate with each other via a TSL secured REST API. The client certificate and client key used for this communication is static and needs to be created by the administrator during the installation. The server certificates, however, are created automatically by Octavia when an amphora is brought up and mapped into the amphora via a config drive. To be able to do this, Octavia has a built-in certificate generator that acts as a cA. 

* a first CA certificate (octavia_ca). This certificate will be used by the certificate generator and will therefore be the CA certificate with which all server certificates are signed and will be used as a client CA certificate by the Octavia control plane when building a connection to the amphora agent
* the private key for this certificate
* a second CA certificate (install_ca). This certificate will be used during installation to create the client certificates, and consequently needs to be deployed to the amphorae to be able to verify connections. Thus this certificate will be used as client CA inside the amphora.
* a private key for this certificate
* a client certificate (client_cert), signed by the install_ca, which is then used by the control plane, combined with the corresponding key in one PEM file


Thus we have the following table that summarizes the various certificates and keys and their role on the respective nodes.

| Node | Role | Certificate |
| --- | --- | --- |
| Amphora | client CA | install_ca |
| Amphora | server certificate | generated by Octavia and signed with octavia_ca |
| Amphora | server private key | generated by Octavia |
| Control plane | client certificate | client_cert |
| Control plane | client private key | client_key |
| Control plane | server CA | octavia_ca |
| Certificate generator | root CA | octavia_ca |
| Certificate generator | private key | octavia_key |

We will create these certificates on the local host and distribute them, on the Octavia nodes, they will be kept in */etc/octavia/certs/*. 


## Configuration file changes

The following changes are made to the default configuration:

Changes done for the API server as well (though they are not all needed, we do this to allow for a configuration were control plane and API server are installed on the same node)

* set the URL for the RabbitMQ interface
* change the *bind_host* variable to the management IP of the node on which we are running
* change the auth strategy to keystone
* only expose the v2 API
* change the values in the auth_token section 
* set a topic name in oslo_messaging
* in the service_auth section, configure the authentication data that Octavia will use to communicate with other services (though this is apparantly not really needed by the API service itself)

Additional changes:

* set the *cert_manager* so that the local cert manager is used (and we do not need Barbican)
* set all certificates according to the table above

Requirements
------------

None

Role Variables
--------------

The following variables need to be set when calling this role.

* db_node - name of the node on which the database is running
* api_node - the node on which Keystone is running
* memcached_node - node on which the memcached server is running
* mariadb_root_password - root password for the database
* octavia_db_user_password - a password that we will use for the octavia DB user
* keystone_admin_password - the Keystone admin password
* octavia_keystone_user_password - a password for the new octavia user in Keystone
* mq_node - the node on which RabbitMQ is running
* rabbitmq_password - password of the RabbitMQ user


Dependencies
------------

None


License
-------

MIT

Author Information
------------------

Visit me at https://www.github.com/christianb93
